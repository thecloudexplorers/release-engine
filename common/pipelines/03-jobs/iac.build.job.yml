parameters:
  - name: workloadSettings
    type: object

jobs:
  - job: ${{ variables.workload }}_build
    displayName: Building IaC Artifacts
    variables:
      - template: ${{ parameters.workloadSettings.configurationFilePath }}/metadata.yml
      

      
      - ${{ if eq(resources.repositories.*.name, 'release-engine-core') }}:
          - name: releaseEngineCheckoutDirectory
            value: releaseEngineCheckoutDirectory
      - ${{ else }}:
          - name: releaseEngineCheckoutDirectory
            value: configurationCheckoutDirectory
      - ${{ if eq(resources.repositories.*.name, 'workload') }}:
          - name: workloadCheckoutDirectory
            value: workloadCheckoutDirectory
      - ${{ else }}:
          - name: workloadCheckoutDirectory
            value: configurationCheckoutDirectory


    steps:
      # - checkout: self
      #   path: configurationCheckoutDirectory
      # - checkout: release-engine-core
      #   path: releaseEngineCheckoutDirectory
      # - checkout: workload
      #   path: workloadCheckoutDirectory

      - checkout: self
        path: configurationCheckoutDirectory
      
      - ${{ if eq(resources.repositories.*.name, 'release-engine-core') }}:
          - checkout: release-engine-core
            path: releaseEngineCheckoutDirectory
      - ${{ if eq(resources.repositories.*.name, 'workload') }}:
          - checkout: workload
            path: workloadCheckoutDirectory

      - task: CopyFiles@2
        displayName: Copying content from Configuration repository
        inputs:
          SourceFolder: $(Pipeline.Workspace)/configurationCheckoutDirectory/${{ parameters.workloadSettings.configurationFilePath }}
          Contents: |
            **
            !pipelines/**
          TargetFolder: $(build.artifactstagingdirectory)/$(workload)/configuration
          flattenFolders: false

      - task: CopyFiles@2
        displayName: Copying Workload content
        inputs:
          SourceFolder: $(Pipeline.Workspace)/$(workloadCheckoutDirectory)/${{ parameters.workloadSettings.workloadArtifactsPath }}
          Contents: |
            **
            !tests/**
            !examples/**
            !workload.yml
          TargetFolder: $(build.artifactstagingdirectory)/$(workload)
          flattenFolders: false

      - task: CopyFiles@2
        displayName: Copying common content
        inputs:
          SourceFolder: $(Pipeline.Workspace)/$(releaseEngineCheckoutDirectory)/common
          Contents: |
            **
            !tests/**
            !examples/**
            !pipelines/**
          TargetFolder: $(build.artifactstagingdirectory)/common
          flattenFolders: false

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: $(build.artifactstagingdirectory)/$(workload)
          artifact: $(workload)
          publishLocation: pipeline

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: $(build.artifactstagingdirectory)/common
          artifact: common
          publishLocation: pipeline
